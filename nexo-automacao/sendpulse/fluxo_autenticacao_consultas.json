{
  "flow_name": "Autentica√ß√£o e Consultas",
  "description": "Fluxo para clientes j√° cadastrados - autentica√ß√£o multifator e consultas automatizadas",
  "version": "1.0.0",
  "created_at": "2026-02-07",
  "webhooks": {
    "identificar_cliente": "https://intranet.mayeradvogados.adv.br/api/nexo/identificar-cliente",
    "perguntas_auth": "https://intranet.mayeradvogados.adv.br/api/nexo/perguntas-auth",
    "validar_auth": "https://intranet.mayeradvogados.adv.br/api/nexo/validar-auth",
    "consulta_status": "https://intranet.mayeradvogados.adv.br/api/nexo/consulta-status"
  },
  "variables": {
    "$encontrado": "boolean - Cliente encontrado no sistema",
    "$cpf_cnpj": "string - CPF/CNPJ mascarado do cliente",
    "$bloqueado": "boolean - Cliente bloqueado por tentativas",
    "$pergunta1": "string - Primeira pergunta de autentica√ß√£o",
    "$opcoes1": "array - Op√ß√µes de resposta para pergunta 1",
    "$pergunta2": "string - Segunda pergunta de autentica√ß√£o",
    "$opcoes2": "array - Op√ß√µes de resposta para pergunta 2",
    "$resposta1": "string - Resposta do cliente √† pergunta 1",
    "$resposta2": "string - Resposta do cliente √† pergunta 2",
    "$auth_ok": "boolean - Autentica√ß√£o bem-sucedida",
    "$tentativas_restantes": "integer - Tentativas restantes",
    "$resposta_ia": "string - Resposta formatada pela IA",
    "$sucesso": "boolean - Consulta realizada com sucesso"
  },
  "flow_structure": [
    {
      "id": "start",
      "type": "start",
      "description": "In√≠cio do fluxo quando cliente seleciona 'J√° sou cliente'",
      "next": "webhook_identificar"
    },
    {
      "id": "webhook_identificar",
      "type": "webhook",
      "description": "Busca cliente pelo telefone no banco de dados",
      "config": {
        "url": "{{webhooks.identificar_cliente}}",
        "method": "GET",
        "params": {
          "telefone": "{{phone}}"
        },
        "headers": {
          "X-Sendpulse-Token": "SEU_TOKEN_AQUI"
        },
        "save_to": ["$encontrado", "$cpf_cnpj", "$bloqueado"]
      },
      "next": "filter_encontrado"
    },
    {
      "id": "filter_encontrado",
      "type": "filter",
      "description": "Verifica se cliente foi encontrado",
      "condition": "$encontrado == true",
      "if_true": "msg_confirma_cpf",
      "if_false": "msg_nao_encontrado"
    },
    {
      "id": "msg_nao_encontrado",
      "type": "message",
      "text": "N√£o encontramos nenhum cadastro vinculado a este telefone. Vou encaminhar voc√™ para nossa equipe.",
      "delay": 2,
      "next": "open_chat_nao_encontrado"
    },
    {
      "id": "open_chat_nao_encontrado",
      "type": "action",
      "action": "open_chat",
      "pause_automation": "1 day"
    },
    {
      "id": "msg_confirma_cpf",
      "type": "message",
      "text": "Ol√° {{nomecompleto}}! Identificamos o CPF/CNPJ {{$cpf_cnpj}} cadastrado neste telefone.\n\nVoc√™ confirma que √© voc√™?",
      "buttons": [
        {
          "text": "‚úÖ Sim, sou eu",
          "next": "webhook_perguntas"
        },
        {
          "text": "‚ùå N√£o sou eu",
          "next": "msg_cpf_incorreto"
        }
      ]
    },
    {
      "id": "msg_cpf_incorreto",
      "type": "message",
      "text": "Sem problemas! Vou encaminhar voc√™ para nossa equipe fazer a verifica√ß√£o.",
      "next": "open_chat_cpf_incorreto"
    },
    {
      "id": "open_chat_cpf_incorreto",
      "type": "action",
      "action": "open_chat",
      "pause_automation": "1 day"
    },
    {
      "id": "webhook_perguntas",
      "type": "webhook",
      "description": "Gera perguntas din√¢micas de autentica√ß√£o",
      "config": {
        "url": "{{webhooks.perguntas_auth}}",
        "method": "POST",
        "body": {
          "telefone": "{{phone}}",
          "cpf_cnpj": "{{$cpf_cnpj}}"
        },
        "headers": {
          "X-Sendpulse-Token": "SEU_TOKEN_AQUI",
          "Content-Type": "application/json"
        },
        "save_to": ["$pergunta1", "$opcoes1", "$pergunta2", "$opcoes2"]
      },
      "next": "msg_pergunta1"
    },
    {
      "id": "msg_pergunta1",
      "type": "message",
      "text": "Para sua seguran√ßa, preciso confirmar alguns dados.\n\n{{$pergunta1}}",
      "buttons_dynamic": "$opcoes1",
      "save_to": "$resposta1",
      "timeout": 180,
      "next": "msg_pergunta2"
    },
    {
      "id": "msg_pergunta2",
      "type": "message",
      "text": "{{$pergunta2}}",
      "buttons_dynamic": "$opcoes2",
      "save_to": "$resposta2",
      "timeout": 180,
      "next": "webhook_validar"
    },
    {
      "id": "webhook_validar",
      "type": "webhook",
      "description": "Valida respostas de autentica√ß√£o",
      "config": {
        "url": "{{webhooks.validar_auth}}",
        "method": "POST",
        "body": {
          "telefone": "{{phone}}",
          "resposta1": "{{$resposta1}}",
          "resposta2": "{{$resposta2}}"
        },
        "headers": {
          "X-Sendpulse-Token": "SEU_TOKEN_AQUI",
          "Content-Type": "application/json"
        },
        "save_to": ["$auth_ok", "$tentativas_restantes", "$bloqueado"]
      },
      "next": "filter_auth"
    },
    {
      "id": "filter_auth",
      "type": "filter",
      "description": "Verifica se autentica√ß√£o foi bem-sucedida",
      "condition": "$auth_ok == true",
      "if_true": "msg_menu_consultas",
      "if_false": "filter_tentativas"
    },
    {
      "id": "filter_tentativas",
      "type": "filter",
      "description": "Verifica tentativas restantes",
      "condition": "$tentativas_restantes > 0",
      "if_true": "msg_auth_falha",
      "if_false": "msg_auth_bloqueio"
    },
    {
      "id": "msg_auth_falha",
      "type": "message",
      "text": "Resposta incorreta. Voc√™ tem {{$tentativas_restantes}} tentativa(s) restante(s).\n\nVamos tentar novamente?",
      "buttons": [
        {
          "text": "Sim, tentar novamente",
          "next": "webhook_perguntas"
        },
        {
          "text": "Falar com atendente",
          "next": "open_chat_manual"
        }
      ]
    },
    {
      "id": "msg_auth_bloqueio",
      "type": "message",
      "text": "Voc√™ atingiu o n√∫mero m√°ximo de tentativas. Por seguran√ßa, vou encaminhar voc√™ para nossa equipe.",
      "next": "open_chat_bloqueio"
    },
    {
      "id": "open_chat_bloqueio",
      "type": "action",
      "action": "open_chat",
      "pause_automation": "30 minutes"
    },
    {
      "id": "msg_menu_consultas",
      "type": "message",
      "text": "Perfeito! Autentica√ß√£o realizada com sucesso.\n\nO que deseja consultar?",
      "buttons": [
        {
          "text": "üìã Status do Processo",
          "next": "webhook_consulta_status"
        },
        {
          "text": "üí∞ Outras consultas",
          "next": "msg_em_breve"
        },
        {
          "text": "üë§ Falar com atendente",
          "next": "open_chat_manual"
        }
      ]
    },
    {
      "id": "webhook_consulta_status",
      "type": "webhook",
      "description": "Consulta status do processo via IA",
      "config": {
        "url": "{{webhooks.consulta_status}}",
        "method": "POST",
        "body": {
          "telefone": "{{phone}}"
        },
        "headers": {
          "X-Sendpulse-Token": "SEU_TOKEN_AQUI",
          "Content-Type": "application/json"
        },
        "save_to": ["$resposta_ia", "$sucesso"]
      },
      "next": "msg_resposta_status"
    },
    {
      "id": "msg_resposta_status",
      "type": "message",
      "text": "{{$resposta_ia}}",
      "next": "msg_mais_alguma_coisa"
    },
    {
      "id": "msg_mais_alguma_coisa",
      "type": "message",
      "text": "Posso ajudar com mais alguma coisa?",
      "buttons": [
        {
          "text": "‚úÖ Sim",
          "next": "msg_menu_consultas"
        },
        {
          "text": "‚ùå N√£o, obrigado",
          "next": "msg_encerrar"
        }
      ]
    },
    {
      "id": "msg_em_breve",
      "type": "message",
      "text": "Esta funcionalidade estar√° dispon√≠vel em breve! Por enquanto, posso te ajudar com outra coisa?",
      "next": "msg_menu_consultas"
    },
    {
      "id": "open_chat_manual",
      "type": "action",
      "action": "open_chat",
      "pause_automation": "1 day"
    },
    {
      "id": "msg_encerrar",
      "type": "message",
      "text": "Foi um prazer atend√™-lo! Estamos √† disposi√ß√£o sempre que precisar. üòä"
    }
  ],
  "notes": [
    "Todas as URLs de webhook devem ter o token X-Sendpulse-Token configurado",
    "Vari√°veis din√¢micas ($pergunta1, $opcoes1, etc) s√£o preenchidas pelos webhooks",
    "Tentativas de autentica√ß√£o s√£o limitadas a 3, com bloqueio de 30 minutos",
    "Respostas de IA s√£o geradas via OpenAI com base nos andamentos processuais"
  ]
}
