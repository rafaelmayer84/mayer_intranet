<?php

namespace App\Services;

use App\Models\Cliente;
use App\Models\Processo;
use App\Models\Movimento;
use App\Models\IntegrationLog;
use App\Services\ClassificacaoService;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;
use Exception;

class DataJuriSyncService
{
    private $baseUrl = 'https://api.datajuri.com.br';
    private $token;
    private $clientId;
    private $secretId;
    private $username;
    private $password;
    private $perPage = 100;
    private $classificacaoService;

    public function __construct(ClassificacaoService $classificacaoService = null)
    {
        $this->clientId = env('DATAJURI_CLIENT_ID');
        $this->secretId = env('DATAJURI_SECRET_ID');
        $this->username = env('DATAJURI_EMAIL');
        $this->password = env('DATAJURI_PASSWORD');
        $this->classificacaoService = $classificacaoService ?? app(ClassificacaoService::class);
    }

    /**
     * Autenticar na API DataJuri
     */
    public function authenticate()
    {
        try {
            $credentials = base64_encode("{$this->clientId}:{$this->secretId}");

            $response = Http::withHeaders([
                'Authorization' => "Basic {$credentials}",
                'Content-Type' => 'application/x-www-form-urlencoded'
            ])->asForm()->post("{$this->baseUrl}/oauth/token", [
                'grant_type' => 'password',
                'username' => $this->username,
                'password' => $this->password
            ]);

            if ($response->successful()) {
                $this->token = $response->json()['access_token'];
                return true;
            }

            $this->logError('DataJuri', 'Autenticação', 'Falha na autenticação: ' . $response->body());
            return false;

        } catch (Exception $e) {
            $this->logError('DataJuri', 'Autenticação', $e->getMessage());
            return false;
        }
    }

    /**
     * Sincronizar todas as entidades com paginação
     */
    public function syncAll()
    {
        if (!$this->authenticate()) {
            return [
                'success' => false,
                'message' => 'Falha na autenticação com DataJuri'
            ];
        }

        $results = [
            'pessoas' => $this->syncPessoasComPaginacao(),
            'processos' => $this->syncProcessosComPaginacao(),
            'movimentos' => $this->syncMovimentosComPaginacao(),
        ];

        return [
            'success' => true,
            'results' => $results
        ];
    }

    /**
     * Sincronizar Pessoas com paginação
     */
    public function syncPessoasComPaginacao()
    {
        try {
            $page = 1;
            $totalSincronizadas = 0;
            $totalErros = 0;

            do {
                try {
                    $response = Http::withHeaders([
                        'Authorization' => "Bearer {$this->token}",
                        'Content-Type' => 'application/json'
                    ])->get("{$this->baseUrl}/v1/entidades/Pessoa", [
                        'page' => $page,
                        'pageSize' => $this->perPage,
                        'campos' => 'id,nome,email,telefone,tipo'
                    ]);

                    if (!$response->successful()) {
                        throw new Exception('Falha ao buscar pessoas: ' . $response->body());
                    }

                    $data = $response->json();
                    $pessoas = $data['rows'] ?? [];

                    if (empty($pessoas)) {
                        break;
                    }

                    foreach ($pessoas as $pessoa) {
                        try {
                            $cliente = Cliente::updateOrCreate(
                                ['datajuri_id' => $pessoa['id'] ?? null],
                                [
                                    'nome' => substr($pessoa['nome'] ?? '', 0, 255),
                                    'email' => substr($pessoa['email'] ?? '', 0, 255),
                                    'telefone' => substr($pessoa['telefone'] ?? '', 0, 20),
                                    'tipo' => substr($pessoa['tipo'] ?? 'PF', 0, 50),
                                    'ativo' => true,
                                ]
                            );
                            $totalSincronizadas++;
                        } catch (Exception $e) {
                            Log::warning("Erro ao sincronizar pessoa {$pessoa['id']}: " . $e->getMessage());
                            $totalErros++;
                        }
                    }

                    $page++;
                } catch (Exception $e) {
                    Log::error("Erro na página {$page} de pessoas: " . $e->getMessage());
                    break;
                }
            } while (count($pessoas) === $this->perPage);

            $this->logSuccess('DataJuri', 'Pessoas', "Sincronizadas {$totalSincronizadas} pessoas ({$totalErros} erros)");
            return ['success' => true, 'count' => $totalSincronizadas, 'errors' => $totalErros];

        } catch (Exception $e) {
            $this->logError('DataJuri', 'Pessoas', $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Sincronizar Processos com paginação
     */
    public function syncProcessosComPaginacao()
    {
        try {
            $page = 1;
            $totalSincronizadas = 0;
            $totalErros = 0;

            do {
                try {
                    $response = Http::withHeaders([
                        'Authorization' => "Bearer {$this->token}",
                        'Content-Type' => 'application/json'
                    ])->get("{$this->baseUrl}/v1/entidades/Processo", [
                        'page' => $page,
                        'pageSize' => $this->perPage,
                        'campos' => 'id,pasta,numero,status,situacao,tipoAcao,valorCausa,proprietario.nome,cliente.nome,dataCadastro'
                    ]);

                    if (!$response->successful()) {
                        throw new Exception('Falha ao buscar processos: ' . $response->body());
                    }

                    $data = $response->json();
                    $processos = $data['rows'] ?? [];

                    if (empty($processos)) {
                        break;
                    }

                    foreach ($processos as $processo) {
                        try {
                            $proc = Processo::updateOrCreate(
                                ['datajuri_id' => $processo['id'] ?? null],
                                [
                                    'numero' => substr($processo['numero'] ?? '', 0, 100),
                                    'descricao' => substr($processo['descricao'] ?? '', 0, 500),
                                    'status' => substr($processo['status'] ?? 'Ativo', 0, 50),
                                    'ativo' => true,
                                ]
                            );
                            $totalSincronizadas++;
                        } catch (Exception $e) {
                            Log::warning("Erro ao sincronizar processo {$processo['id']}: " . $e->getMessage());
                            $totalErros++;
                        }
                    }

                    $page++;
                } catch (Exception $e) {
                    Log::error("Erro na página {$page} de processos: " . $e->getMessage());
                    break;
                }
            } while (count($processos) === $this->perPage);

            $this->logSuccess('DataJuri', 'Processos', "Sincronizados {$totalSincronizadas} processos ({$totalErros} erros)");
            return ['success' => true, 'count' => $totalSincronizadas, 'errors' => $totalErros];

        } catch (Exception $e) {
            $this->logError('DataJuri', 'Processos', $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Sincronizar Movimentos com paginação
     * VERSÃO CORRIGIDA - 03/02/2026
     * - Removido parâmetro 'criterio' que quebrava a API
     * - Removido parâmetro 'removerHtml' que quebrava a API
     * - Extração correta do codigo_plano de planoConta.nomeCompleto
     * - Parse correto de valores com HTML e formato brasileiro
     * - Parse correto de datas DD/MM/YYYY
     */
    public function syncMovimentosComPaginacao()
    {
        try {
            $page = 1;
            $totalSincronizadas = 0;
            $totalErros = 0;

            do {
                try {
                    // CORREÇÃO: Removido 'criterio' e 'removerHtml' que quebravam a API
                    $response = Http::withHeaders([
                        'Authorization' => "Bearer {$this->token}",
                        'Content-Type' => 'application/json'
                    ])->get("{$this->baseUrl}/v1/entidades/Movimento", [
                        'page' => $page,
                        'pageSize' => $this->perPage,
                        'campos' => 'id,data,valor,valorComSinal,tipo,descricao,planoConta.nomeCompleto,pessoa.nome,formaPagamento,observacao,conta,conciliado,dataCadastro'
                    ]);

                    if (!$response->successful()) {
                        throw new Exception('Falha ao buscar movimentos: ' . $response->body());
                    }

                    $data = $response->json();
                    $movimentos = $data['rows'] ?? [];

                    if (empty($movimentos)) {
                        break;
                    }

                    foreach ($movimentos as $movimento) {
                        try {
                            // ============================================
                            // CORREÇÃO: Extrair codigo_plano corretamente
                            // ============================================
                            // A API retorna planoConta.nomeCompleto no formato:
                            // "3.01 RESULTADO OPERACIONAL:3.01.01 RECEITA BRUTA:3.01.01.01 - Receita bruta - Contrato PF"
                            
                            $planoContaCompleto = $movimento['planoConta.nomeCompleto'] 
                                ?? $movimento['planoConta']['nomeCompleto'] 
                                ?? null;
                            
                            $codigoPlano = $this->extrairCodigoPlano($planoContaCompleto);
                            
                            // ============================================
                            // CORREÇÃO: Parsear valor com HTML
                            // ============================================
                            // A API retorna: <span class='valor-positivo'>830,09</span>
                            // ou: <span class='valor-negativo'>-638,28</span>
                            
                            $valorRaw = $movimento['valorComSinal'] ?? $movimento['valor'] ?? '0';
                            $valor = $this->parseValorBrasileiro($valorRaw);
                            
                            // ============================================
                            // CORREÇÃO: Parsear data DD/MM/YYYY
                            // ============================================
                            $dataRaw = $movimento['data'] ?? null;
                            $dataFormatada = $this->parseDataBrasileira($dataRaw);
                            
                            // Determinar tipo baseado no sinal do valor ou descrição
                            $tipo = $valor >= 0 ? 'receita' : 'despesa';
                            $descricao = $movimento['descricao'] ?? '';
                            
                            // Se descrição começa com "D -" ou "D ", é despesa
                            if (preg_match('/^D[\s\-]/i', trim($descricao))) {
                                $tipo = 'despesa';
                            } elseif (preg_match('/^C[\s\-]/i', trim($descricao))) {
                                $tipo = 'receita';
                            }
                            
                            // Classificar usando o código do plano
                            $classificacao = $this->classificarMovimento($codigoPlano, $tipo);
                            
                            // Buscar regra na tabela para garantir consistência
                            if ($codigoPlano) {
                                $regra = DB::table('classificacao_regras')
                                    ->where('codigo_plano', $codigoPlano)
                                    ->where('ativo', true)
                                    ->first();
                                    
                                if ($regra) {
                                    $classificacao = $regra->classificacao;
                                }
                            }
                            
                            // Calcular ano e mês
                            $ano = $dataFormatada ? (int)date('Y', strtotime($dataFormatada)) : (int)date('Y');
                            $mes = $dataFormatada ? (int)date('n', strtotime($dataFormatada)) : (int)date('n');
                            
                            // Pessoa
                            $pessoa = $movimento['pessoa.nome'] 
                                ?? $movimento['pessoa']['nome'] 
                                ?? null;
                            
                            // Conciliado
                            $conciliadoRaw = $movimento['conciliado'] ?? 'Não';
                            $conciliado = (strtolower($conciliadoRaw) === 'sim' || $conciliadoRaw === true || $conciliadoRaw === 1);
                            
                            $mov = Movimento::updateOrCreate(
                                ['datajuri_id' => $movimento['id'] ?? null],
                                [
                                    'origem' => 'datajuri',
                                    'data' => $dataFormatada,
                                    'data_movimento' => $dataFormatada,
                                    'mes' => $mes,
                                    'ano' => $ano,
                                    'valor' => abs($valor),
                                    'descricao' => substr($descricao, 0, 500),
                                    'observacao' => substr($movimento['observacao'] ?? '', 0, 1000),
                                    'plano_contas' => substr($planoContaCompleto ?? '', 0, 500),
                                    'codigo_plano' => $codigoPlano,
                                    'classificacao' => $classificacao,
                                    'tipo_classificacao' => $tipo,
                                    'pessoa' => substr($pessoa ?? '', 0, 255),
                                    'conta' => substr($movimento['conta'] ?? '', 0, 100),
                                    'conciliado' => $conciliado,
                                    'updated_at_api' => now(),
                                ]
                            );
                            $totalSincronizadas++;
                        } catch (Exception $e) {
                            Log::warning("Erro ao sincronizar movimento {$movimento['id']}: " . $e->getMessage());
                            $totalErros++;
                        }
                    }

                    $page++;
                    
                    // Log de progresso a cada 10 páginas
                    if ($page % 10 === 0) {
                        Log::info("Sincronização DataJuri: página {$page}, {$totalSincronizadas} movimentos processados");
                    }
                    
                } catch (Exception $e) {
                    Log::error("Erro na página {$page} de movimentos: " . $e->getMessage());
                    break;
                }
            } while (count($movimentos) === $this->perPage);

            $this->logSuccess('DataJuri', 'Movimentos', "Sincronizados {$totalSincronizadas} movimentos ({$totalErros} erros)");
            return ['success' => true, 'count' => $totalSincronizadas, 'errors' => $totalErros];

        } catch (Exception $e) {
            $this->logError('DataJuri', 'Movimentos', $e->getMessage());
            return ['success' => false, 'error' => $e->getMessage()];
        }
    }

    /**
     * Extrai o código do plano de contas do campo nomeCompleto
     * 
     * Exemplo de entrada: "3.01 RESULTADO OPERACIONAL:3.01.01 RECEITA BRUTA:3.01.01.01 - Receita bruta - Contrato PF"
     * Saída esperada: "3.01.01.01"
     */
    private function extrairCodigoPlano(?string $planoCompleto): ?string
    {
        if (empty($planoCompleto)) {
            return null;
        }
        
        // Padrão 1: Código no formato X.XX.XX.XX antes de " - "
        if (preg_match('/(\d+\.\d+\.\d+\.\d+)\s*-/', $planoCompleto, $matches)) {
            return $matches[1];
        }
        
        // Padrão 2: Último código no formato X.XX.XX.XX em qualquer lugar
        if (preg_match_all('/(\d+\.\d+\.\d+\.\d+)/', $planoCompleto, $matches)) {
            return end($matches[1]);
        }
        
        // Padrão 3: Código no formato X.XX.XX (3 níveis)
        if (preg_match_all('/(\d+\.\d+\.\d+)(?!\.\d)/', $planoCompleto, $matches)) {
            return end($matches[1]);
        }
        
        // Padrão 4: Código no formato X.XX (2 níveis)
        if (preg_match_all('/(\d+\.\d+)(?!\.\d)/', $planoCompleto, $matches)) {
            return end($matches[1]);
        }
        
        return null;
    }

    /**
     * Converte valor no formato brasileiro (com HTML) para float
     * 
     * Exemplos de entrada:
     *   "<span class='valor-positivo'>830,09</span>" => 830.09
     *   "<span class='valor-negativo'>638,28</span>" => -638.28
     *   "1.234,56" => 1234.56
     *   "-830,09" => -830.09
     */
    private function parseValorBrasileiro($valor): float
    {
        if (is_numeric($valor)) {
            return (float) $valor;
        }
        
        if (empty($valor) || !is_string($valor)) {
            return 0.0;
        }
        
        // Detectar negativo pela classe CSS 'valor-negativo' OU pelo sinal '-'
        $negativo = (strpos($valor, 'valor-negativo') !== false) || (strpos($valor, '-') !== false);
        
        // Remover tags HTML
        $valor = strip_tags($valor);
        $valor = trim($valor);
        
        // Remover tudo que não seja número, vírgula ou ponto
        $valor = preg_replace('/[^\d,.]/', '', $valor);
        
        // Se tem vírgula e ponto, assumir formato brasileiro (1.234,56)
        if (strpos($valor, ',') !== false && strpos($valor, '.') !== false) {
            $valor = str_replace('.', '', $valor);
            $valor = str_replace(',', '.', $valor);
        } elseif (strpos($valor, ',') !== false) {
            $valor = str_replace(',', '.', $valor);
        }
        
        $resultado = (float) $valor;
        
        return $negativo ? -abs($resultado) : $resultado;
    }

    /**
     * Converte data do formato brasileiro (DD/MM/YYYY) para Y-m-d
     */
    private function parseDataBrasileira($data): ?string
    {
        if (empty($data)) {
            return null;
        }
        
        // Se já está no formato Y-m-d, retornar
        if (preg_match('/^\d{4}-\d{2}-\d{2}/', $data)) {
            return substr($data, 0, 10);
        }
        
        // Formato DD/MM/YYYY ou DD/MM/YYYY HH:MM
        if (preg_match('/^(\d{2})\/(\d{2})\/(\d{4})/', $data, $matches)) {
            $dia = $matches[1];
            $mes = $matches[2];
            $ano = $matches[3];
            
            if (checkdate((int)$mes, (int)$dia, (int)$ano)) {
                return "{$ano}-{$mes}-{$dia}";
            }
        }
        
        // Tentar parse genérico
        try {
            $timestamp = strtotime($data);
            if ($timestamp !== false) {
                return date('Y-m-d', $timestamp);
            }
        } catch (Exception $e) {
            // Ignorar
        }
        
        return null;
    }

    // Métodos antigos mantidos para compatibilidade
    public function syncPessoas()
    {
        return $this->syncPessoasComPaginacao();
    }

    public function syncProcessos()
    {
        return $this->syncProcessosComPaginacao();
    }

    public function syncMovimentos()
    {
        return $this->syncMovimentosComPaginacao();
    }

    /**
     * Registrar log de sucesso
     */
    private function logSuccess($sistema, $tipo, $mensagem)
    {
        try {
            IntegrationLog::create([
                'sync_id' => Str::uuid(),
                'tipo' => $tipo,
                'fonte' => 'datajuri',
                'status' => 'concluido',
                'registros_processados' => 0
            ]);
        } catch (Exception $e) {
            Log::error("Erro ao registrar log de sucesso: " . $e->getMessage());
        }

        Log::info("[{$sistema}] {$tipo}: {$mensagem}");
    }

    /**
     * Registrar log de erro
     */
    private function logError($sistema, $tipo, $mensagem)
    {
        try {
            IntegrationLog::create([
                'sync_id' => Str::uuid(),
                'tipo' => $tipo,
                'fonte' => 'datajuri',
                'status' => 'erro',
                'mensagem_erro' => $mensagem
            ]);
        } catch (Exception $e) {
            Log::error("Erro ao registrar log de erro: " . $e->getMessage());
        }

        Log::error("[{$sistema}] {$tipo}: {$mensagem}");
    }

    /**
     * Classifica um movimento usando o ClassificacaoService
     */
    private function classificarMovimento(?string $codigoPlano, ?string $tipo): string
    {
        return $this->classificacaoService->classificar($codigoPlano, $tipo);
    }
}
