<?php

namespace App\Http\Controllers;

use App\Models\WaConversation;
use App\Models\WaMessage;
use App\Services\NexoConversationSyncService;
use App\Services\SendPulseWhatsAppService;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;

/**
 * NexoAtendimentoController
 *
 * Fase 1: Endpoints funcionais (JSON) — a view Blade será entregue na Fase 2.
 * Fase 2: View completa com layout 3 colunas.
 */
class NexoAtendimentoController extends Controller
{
    public function __construct(
        protected NexoConversationSyncService $syncService,
        protected SendPulseWhatsAppService $sendpulseService
    ) {}

    /**
     * Tela principal — STUB Fase 1 (será substituída na Fase 2).
     */
    public function index()
    {
        // Fase 2: return view('nexo.atendimento.index', [...]);
        return response()->view('nexo.atendimento.stub', [
            'title' => 'Nexo — Atendimento WhatsApp',
            'fase'  => 1,
        ]);
    }

    /**
     * Lista inbox (JSON paginado com filtros).
     */
    public function conversas(Request $request): JsonResponse
    {
        $query = WaConversation::query()
            ->with('assignedUser:id,name')
            ->orderByDesc('last_message_at');

        // Filtros
        if ($request->filled('status')) {
            $query->where('status', $request->input('status'));
        }
        if ($request->filled('responsavel')) {
            $query->where('assigned_user_id', $request->input('responsavel'));
        }
        if ($request->filled('unread') && $request->input('unread') === '1') {
            $query->where('unread_count', '>', 0);
        }
        if ($request->filled('tipo')) {
            $tipo = $request->input('tipo');
            if ($tipo === 'lead') {
                $query->whereNotNull('linked_lead_id');
            } elseif ($tipo === 'cliente') {
                $query->whereNotNull('linked_cliente_id');
            } elseif ($tipo === 'indefinido') {
                $query->whereNull('linked_lead_id')->whereNull('linked_cliente_id');
            }
        }

        $conversas = $query->paginate(30);

        return response()->json($conversas);
    }

    /**
     * Detalhes de conversa + mensagens.
     */
    public function conversa(int $id): JsonResponse
    {
        $conversation = WaConversation::with([
            'assignedUser:id,name',
            'lead:id,nome,telefone,intencao_contratar,area_interesse,urgencia',
            'cliente:id,nome,telefone,documento',
        ])->findOrFail($id);

        $messages = $conversation->messages()
            ->orderBy('sent_at', 'asc')
            ->limit(200)
            ->get();

        return response()->json([
            'conversation' => $conversation,
            'messages'     => $messages,
        ]);
    }

    /**
     * Enviar mensagem humana.
     */
    public function enviarMensagem(Request $request, int $id): JsonResponse
    {
        $request->validate([
            'text' => 'required|string|max:4096',
        ]);

        $conversation = WaConversation::findOrFail($id);
        $userId = auth()->id();

        $result = $this->syncService->sendHumanMessage(
            $conversation,
            $request->input('text'),
            $userId
        );

        if (!$result['success']) {
            return response()->json([
                'success' => false,
                'error'   => $result['error'],
            ], 422);
        }

        return response()->json([
            'success' => true,
            'message' => $result['message'],
        ]);
    }

    /**
     * Polling: buscar mensagens novas do chat atual.
     */
    public function pollMessages(int $id): JsonResponse
    {
        $conversation = WaConversation::findOrFail($id);

        $newCount = $this->syncService->syncMessages($conversation, 50);

        // Retornar mensagens mais recentes
        $messages = $conversation->messages()
            ->orderBy('sent_at', 'asc')
            ->limit(200)
            ->get();

        return response()->json([
            'new_count' => $newCount,
            'messages'  => $messages,
        ]);
    }

    /**
     * Atribuir responsável.
     */
    public function assignUser(Request $request, int $id): JsonResponse
    {
        $request->validate([
            'user_id' => 'required|exists:users,id',
        ]);

        $conversation = WaConversation::findOrFail($id);
        $conversation->update(['assigned_user_id' => $request->input('user_id')]);

        return response()->json(['success' => true]);
    }

    /**
     * Alterar status (open/close).
     */
    public function changeStatus(Request $request, int $id): JsonResponse
    {
        $request->validate([
            'status' => 'required|in:open,closed',
        ]);

        $conversation = WaConversation::findOrFail($id);

        $updateData = ['status' => $request->input('status')];

        // Se fechando, zerar unread
        if ($request->input('status') === 'closed') {
            $updateData['unread_count'] = 0;
        }

        $conversation->update($updateData);

        return response()->json(['success' => true]);
    }

    /**
     * Vincular conversa a lead.
     */
    public function linkLead(Request $request, int $id): JsonResponse
    {
        $request->validate([
            'lead_id' => 'required|exists:leads,id',
        ]);

        $conversation = WaConversation::findOrFail($id);
        $conversation->update(['linked_lead_id' => $request->input('lead_id')]);

        return response()->json(['success' => true]);
    }

    /**
     * Vincular conversa a cliente.
     */
    public function linkCliente(Request $request, int $id): JsonResponse
    {
        $request->validate([
            'cliente_id' => 'required|exists:clientes,id',
        ]);

        $conversation = WaConversation::findOrFail($id);
        $conversation->update(['linked_cliente_id' => $request->input('cliente_id')]);

        return response()->json(['success' => true]);
    }

    /**
     * Contexto 360: dados de DataJuri + EspoCRM + Lead IA.
     */
    public function contexto360(int $id): JsonResponse
    {
        $conversation = WaConversation::with([
            'lead',
            'cliente.processos' => function ($q) {
                $q->select('id', 'numero', 'status', 'cliente_id')
                  ->orderByDesc('created_at')
                  ->limit(5);
            },
            'cliente.contasReceber' => function ($q) {
                $q->where('status', 'aberta')
                  ->select('id', 'cliente_id', 'valor', 'data_vencimento', 'status');
            },
        ])->findOrFail($id);

        $contexto = [
            'link_type' => $conversation->link_type,
        ];

        // Dados do Lead (com campos IA)
        if ($conversation->lead) {
            $lead = $conversation->lead;
            $contexto['lead'] = [
                'id'                    => $lead->id,
                'nome'                  => $lead->nome,
                'telefone'              => $lead->telefone,
                'area_interesse'        => $lead->area_interesse ?? null,
                'intencao_contratar'    => $lead->intencao_contratar ?? null,
                'urgencia'              => $lead->urgencia ?? null,
                'sub_area'              => $lead->sub_area ?? null,
                'complexidade'          => $lead->complexidade ?? null,
                'objecoes'              => $lead->objecoes ?? null,
                'gatilho_emocional'     => $lead->gatilho_emocional ?? null,
                'potencial_honorarios'  => $lead->potencial_honorarios ?? null,
                'resumo_demanda'        => $lead->resumo_demanda ?? null,
                'palavras_chave'        => $lead->palavras_chave ?? null,
                'intencao_justificativa' => $lead->intencao_justificativa ?? null,
            ];
        }

        // Dados do Cliente DataJuri
        if ($conversation->cliente) {
            $cliente = $conversation->cliente;
            $contexto['cliente'] = [
                'id'               => $cliente->id,
                'nome'             => $cliente->nome,
                'tipo_pessoa'      => $cliente->tipo_pessoa ?? $cliente->tipo ?? null,
                'documento'        => $cliente->documento ?? null,
                'processos_ativos' => $cliente->processos?->toArray() ?? [],
                'contas_abertas'   => $cliente->contasReceber?->toArray() ?? [],
            ];
        }

        return response()->json($contexto);
    }
}
