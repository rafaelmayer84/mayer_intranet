<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     * 
     * OBJETIVO: Preservar tabela 'leads' existente renomeando-a para 'leads_legacy'
     * antes de criar a nova estrutura do módulo Central de Leads (WhatsApp Bot).
     * 
     * CONTEXTO: A tabela 'leads' atual contém 198 registros de um sistema anterior
     * com campos como: email, origem, responsavel_id, motivo_perda, data_conversao.
     * Esta migration garante que esses dados históricos sejam preservados.
     */
    public function up(): void
    {
        // Verificar se a tabela 'leads' existe
        if (Schema::hasTable('leads')) {
            
            // Log da operação
            DB::statement("
                INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, detalhes, inicio, created_at, updated_at) 
                VALUES (
                    'Central de Leads', 
                    'migracao', 
                    'sistema', 
                    'em_andamento', 
                    'Backup da tabela leads', 
                    'Renomeando tabela leads para leads_legacy. Total de registros a preservar: " . DB::table('leads')->count() . "',
                    NOW(),
                    NOW(),
                    NOW()
                )
            ");
            
            try {
                // Renomear tabela existente para leads_legacy
                Schema::rename('leads', 'leads_legacy');
                
                // Log de sucesso
                DB::statement("
                    INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, detalhes, fim, created_at, updated_at) 
                    VALUES (
                        'Central de Leads', 
                        'migracao', 
                        'sistema', 
                        'sucesso', 
                        'Backup da tabela leads concluído', 
                        'Tabela leads renomeada para leads_legacy com sucesso. Registros preservados: " . DB::table('leads_legacy')->count() . "',
                        NOW(),
                        NOW(),
                        NOW()
                    )
                ");
                
            } catch (\Exception $e) {
                // Log de erro
                DB::statement("
                    INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, mensagem_erro, detalhes, fim, created_at, updated_at) 
                    VALUES (
                        'Central de Leads', 
                        'migracao', 
                        'sistema', 
                        'erro', 
                        'Erro ao fazer backup da tabela leads', 
                        " . DB::getPdo()->quote($e->getMessage()) . ",
                        " . DB::getPdo()->quote('Erro ao renomear tabela: ' . $e->getMessage()) . ",
                        NOW(),
                        NOW(),
                        NOW()
                    )
                ");
                
                throw $e;
            }
            
        } else {
            // Tabela não existe, nada a fazer
            DB::statement("
                INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, detalhes, created_at, updated_at) 
                VALUES (
                    'Central de Leads', 
                    'migracao', 
                    'sistema', 
                    'pulado', 
                    'Backup da tabela leads não necessário', 
                    'Tabela leads não existe. Nenhuma ação necessária.',
                    NOW(),
                    NOW()
                )
            ");
        }
    }

    /**
     * Reverse the migrations.
     * 
     * ATENÇÃO: Este rollback restaura a tabela original, mas a nova tabela 'leads'
     * do módulo WhatsApp será perdida. Execute apenas se tiver certeza.
     */
    public function down(): void
    {
        // Se leads_legacy existe e leads não existe, restaurar
        if (Schema::hasTable('leads_legacy') && !Schema::hasTable('leads')) {
            
            DB::statement("
                INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, detalhes, inicio, created_at, updated_at) 
                VALUES (
                    'Central de Leads', 
                    'rollback', 
                    'sistema', 
                    'em_andamento', 
                    'Restauração da tabela leads_legacy', 
                    'Restaurando tabela leads_legacy para leads',
                    NOW(),
                    NOW(),
                    NOW()
                )
            ");
            
            Schema::rename('leads_legacy', 'leads');
            
            DB::statement("
                INSERT INTO integration_logs (sistema, tipo, fonte, status, mensagem, detalhes, fim, created_at, updated_at) 
                VALUES (
                    'Central de Leads', 
                    'rollback', 
                    'sistema', 
                    'sucesso', 
                    'Restauração da tabela leads_legacy concluída', 
                    'Tabela leads_legacy restaurada para leads com sucesso',
                    NOW(),
                    NOW(),
                    NOW()
                )
            ");
        }
    }
};
